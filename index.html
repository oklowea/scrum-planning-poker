<!DOCTYPE html>
<html>
  <head>
    <title>Online Scrum Planning</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body>
    <div class="container mx-auto my-6">
      <div class="grid grid-cols-7">
        <div class="col-start-3 col-span-3">
          <div class="flex justify-between items-center">
            <div>Choose your estimate...</div>
            <button data-js="reset" class="bg-gray-200 hover:bg-sky-500/50 py-2 px-12 rounded-md flex justify-start items-center">
              <div class="mr-2">
                <svg data-name="Layer 1" id="Layer_1" width="24px" height="24px" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"><path d="M218.39,320.61,246.77,349H157a93,93,0,0,1,0-186h18V133H157a123,123,0,0,0,0,246h89.77l-28.38,28.38,21.22,21.23L304.22,364l-64.61-64.61Z"/><path d="M355,133H265.23l28.38-28.38L272.39,83.39,207.78,148l64.61,64.61,21.22-21.22L265.23,163H355a93,93,0,0,1,0,186H336.44v30H355a123,123,0,0,0,0-246Z"/></svg>
              </div>
              Reset
            </button>
          </div>
          <div data-js="options" class="flex justify-start my-6">
            <div class="flex justify-center items-center w-12 h-20 bg-gray-200 hover:bg-sky-500/50 mr-2 rounded-md cursor-pointer">0</div>
            <div class="flex justify-center items-center w-12 h-20 bg-gray-200 hover:bg-sky-500/50 mx-2 rounded-md cursor-pointer">1/2</div>
            <div class="flex justify-center items-center w-12 h-20 bg-gray-200 hover:bg-sky-500/50 mx-2 rounded-md cursor-pointer">1</div>
            <div class="flex justify-center items-center w-12 h-20 bg-gray-200 hover:bg-sky-500/50 mx-2 rounded-md cursor-pointer">2</div>
            <div class="flex justify-center items-center w-12 h-20 bg-gray-200 hover:bg-sky-500/50 mx-2 rounded-md cursor-pointer">3</div>
            <div class="flex justify-center items-center w-12 h-20 bg-gray-200 hover:bg-sky-500/50 mx-2 rounded-md cursor-pointer">5</div>
            <div class="flex justify-center items-center w-12 h-20 bg-gray-200 hover:bg-sky-500/50 mx-2 rounded-md cursor-pointer">8</div>
            <div class="flex justify-center items-center w-12 h-20 bg-gray-200 hover:bg-sky-500/50 mx-2 rounded-md cursor-pointer">13</div>
            <div class="flex justify-center items-center w-12 h-20 bg-gray-200 hover:bg-sky-500/50 mx-2 rounded-md cursor-pointer">20</div>
            <div class="flex justify-center items-center w-12 h-20 bg-gray-200 hover:bg-sky-500/50 mx-2 rounded-md cursor-pointer">40</div>
            <div class="flex justify-center items-center w-12 h-20 bg-gray-200 hover:bg-sky-500/50 ml-2 rounded-md cursor-pointer">100</div>
          </div>

          <div class="form-check mb-6">
            <label data-js="label-voter" class="border-2 border-gray-200 hover:bg-gray-200 py-2 px-4 rounded-md inline-flex justify-start items-center cursor-pointer">
              <input data-js="voter" class="h-4 w-4 rounded-md mr-2" type="checkbox" checked />
              <span>You are a voter</span>
            </label>
          </div>
      
          <div data-js="current-option">You haven't estimated yet</div>
          <div data-js="result" class="flex justify-start my-6"></div>
          <div data-js="average" class="flex justify-start"></div>
        </div>
      </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      var socket = io();

      let selectedPrices = [];
      let usersCount = 0;

      let isEnd = false;
      let isWeCanVote = false;
      let votes = [];
      let unVotes = [];

      const currentEstimateElement = document.querySelector('[data-js="current-option"]');
      const eyeIcon = '<svg height="32px" fill="#912300" id="Layer_1" version="1.1" viewBox="0 0 64 64" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><g><path clip-rule="evenodd" d="M32,7.173C18.311,7.173,7.174,18.311,7.174,32   c0,13.689,11.137,24.827,24.826,24.827c13.689,0,24.826-11.138,24.826-24.827C56.826,18.311,45.689,7.173,32,7.173z M32,43.064   c-11.6,0-17.855-10.826-17.855-10.826S20.4,21.41,32,21.41c11.601,0,17.856,10.828,17.856,10.828S43.601,43.064,32,43.064z" fill-rule="evenodd"/><path clip-rule="evenodd" d="M32,23.005c-5.091,0-9.232,4.142-9.232,9.232c0,5.09,4.142,9.231,9.232,9.231   s9.232-4.142,9.232-9.231C41.232,27.147,37.091,23.005,32,23.005z M32,38.469c-3.437,0-6.232-2.796-6.232-6.231   c0-3.437,2.796-6.232,6.232-6.232s6.232,2.796,6.232,6.232C38.232,35.673,35.437,38.469,32,38.469z" fill-rule="evenodd"/><path clip-rule="evenodd" d="M34.297,32.614c-1.229,0-2.225-0.996-2.225-2.227   c0-1.103,0.809-2.015,1.867-2.188c-0.589-0.284-1.241-0.457-1.939-0.457c-2.48,0-4.494,2.017-4.494,4.495   c0,2.483,2.014,4.494,4.494,4.494c2.481,0,4.494-2.011,4.494-4.494c0-0.358-0.053-0.702-0.132-1.036   C36.037,32.028,35.237,32.614,34.297,32.614z" fill-rule="evenodd"/></g></svg>';

      function setSelectedPrices(prices) {
        selectedPrices = prices;

        votes = selectedPrices.filter(o => o.price !== -1);
        unVotes = selectedPrices.filter(o => o.price === -1);

        isEnd = usersCount - unVotes.length === votes.length && votes.length > 1;
        isWeCanVote = !unVotes.find(o => o.id === socket.id);
      }

      const voter = document.querySelector('[data-js="voter"]');
      const labelVoter = document.querySelector('[data-js="label-voter"] span');
      voter.addEventListener('change', () => {
        if(voter.checked) {
          labelVoter.innerHTML = 'You are a voter';
          socket.emit('selected:option', null);
        } else {
          labelVoter.innerHTML = 'You are not a voter';
          socket.emit('selected:option', -1);
        }
      });

      const reset = document.querySelector('[data-js="reset"]');
      reset.addEventListener('click', () => {
        socket.emit('reset');
      });

      const options = document.querySelectorAll('[data-js="options"] div');
      options.forEach(option => option.addEventListener('click', choseVariant));

      function choseVariant() {
        if(isEnd || (!isEnd && !isWeCanVote)) {
          return;
        }

        options.forEach(option => {
          option.classList.remove('bg-sky-500/50');
        });

        if(this.innerHTML === '1/2') {
          socket.emit('selected:option', 0.5);
        } else {
          socket.emit('selected:option', Number(this.innerHTML));
        }

        this.classList.add('bg-sky-500/50');
      }

      socket.on('users:count', (count) => {
        usersCount = count;

        const result = document.querySelector('[data-js="result"]');
        result.innerHTML = '';
        for (let i = 0; i < usersCount; i++) {
          result.innerHTML += '<div class="flex justify-center items-center w-12 h-20 bg-gray-200 mr-2 rounded-md"></div>';
        }
      });

      socket.on('selected:prices', (prices) => {
        setSelectedPrices(prices);

        const options = document.querySelectorAll('[data-js="options"] div');
        options.forEach(option => {
          option.classList.remove('bg-sky-500/50');
        });

        for (let i = 0; i < usersCount; i++) { 
          const item = document.querySelector(`[data-js="result"] div:nth-child(${i + 1})`);
          item.classList.remove('bg-red-200');
          item.classList.remove('bg-sky-500/50');
          item.innerHTML = '';
        }
        
        currentEstimateElement.innerHTML = 'You haven\'t estimated yet';

        if(selectedPrices.length) {
          const selectedPrice = selectedPrices.find((o) => o.id === socket.id);
          if (selectedPrice) {
            document.querySelectorAll('[data-js="options"] div').forEach((option) => {
              const price = option.innerHTML === '1/2' ? 0.5 : Number(option.innerHTML);
              if (price === selectedPrice.price) {
                option.classList.add('bg-sky-500/50');
              }
            });

            if(selectedPrice.price === 0.5) {
              currentEstimateElement.innerHTML = 'Your current estimate: 1/2';
            } else if (selectedPrice.price === -1) {
              currentEstimateElement.innerHTML = '&nbsp;';
            } else {
              currentEstimateElement.innerHTML = `Your current estimate: ${selectedPrice.price}`;
            }
          }

          for (let i = 0; i < selectedPrices.length; i++) { 
            const item = document.querySelector(`[data-js="result"] div:nth-child(${i + 1})`);

            if (selectedPrices[i].price === -1) {
              item.classList.add('bg-red-200');
              item.innerHTML = eyeIcon;
            } else {
              item.innerHTML = 'X';

              if (selectedPrices[i].id === socket.id) {
                item.classList.add('bg-sky-500/50');
              }
            }
          }

          const average = document.querySelector('[data-js="average"]');
          if (isEnd) {
            let summa = 0;
            for (let i = 0; i < selectedPrices.length; i++) {
              const item = document.querySelector(`[data-js="result"] div:nth-child(${i + 1})`);
              if(selectedPrices[i].price === 0.5) {
                item.innerHTML = '1/2';
              } else if (selectedPrices[i].price === -1) {
                item.innerHTML = eyeIcon;
              } else {
                item.innerHTML = selectedPrices[i].price;
              }

              if (selectedPrices[i].price !== -1) {
                summa += selectedPrices[i].price;
              }
            }

            const result = summa / votes.length;
            if (Math.ceil(result) === result) {
              average.innerHTML = `Average: ${result}`;
            } else {
              average.innerHTML = `Average: ${Math.ceil(result)} (${result.toFixed(2)})`;
            }
          } else {
            average.innerHTML = '';
          }
        } else {
          currentEstimateElement.innerHTML = `You haven't estimated yet`;

          const items = document.querySelectorAll('[data-js="result"] div');
          items.forEach(item => {
            item.innerHTML = '';
            item.classList.add('bg-gray-200');
            item.classList.remove('bg-sky-500/50');
          });

          const average = document.querySelector('[data-js="average"]');
          average.innerHTML = '';
        }
      });
    </script>
  </body>
</html>
